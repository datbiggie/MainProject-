{% load static %}


{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Registro Empresa</title>
    <link rel="stylesheet" href="{% static 'registrar_empresa/css/main.css' %}">
    <link rel="stylesheet" href="{% static 'registrar_empresa/css/steps.css' %}">
    <link rel="stylesheet" href="{% static 'barra_superior/css/main.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyArSSR_2q1ZpCJCOKWNLtuCLc5Z2imrzZY&libraries=places" async defer></script>
  {% include 'ecommerce_app/barra_superior_bienvenido.html'%}

</head>

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <defs>
        <symbol xmlns="http://www.w3.org/2000/svg" id="home" viewBox="0 0 24 24"><path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8z"/></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="user" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="9" r="3"/><circle cx="12" cy="12" r="10"/><path stroke-linecap="round" d="M17.97 20c-.16-2.892-1.045-5-5.97-5s-5.81 2.108-5.97 5"/></g></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" id="faq" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41c0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></symbol>
    </defs>
</svg>
<body>
{% if has_company %}
<script>
  window.location.href = "{% url 'sucursalfuncion' %}";
</script>
{% endif %}
<div class="top-bar-ecommerce">
    <div class="top-bar-left">
        <a href="{% url 'index' %}">
            <img src="{% static 'barra_superior/images/logo.jpg' %}" alt="Logo" class="img-fluid">
        </a>
        <p class="top-bar-text">Bienvenido a la tienda virtual de Todo Aquí</p>
    </div>
    
    <div class="top-bar-right">
        <ul class="d-flex justify-content-end align-items-center list-unstyled m-0 py-0 my-0">
            <li>
                <a href="{% url 'index' %}" class="p-2 mx-1" title="Inicio">
                    <svg width="24" height="24"><use xlink:href="#home"></use></svg>
                </a>
            </li>
            <li>
                <a href="#" class="p-2 mx-1" data-bs-toggle="modal" data-bs-target="#sesionModal">
                    <svg width="24" height="24"><use xlink:href="#user"></use></svg>
                </a>
            </li>
            <li>
                <a href="#" class="p-2 mx-1" title="Preguntas Frecuentes">
                    <svg width="24" height="24"><use xlink:href="#faq"></use></svg>
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- Modal para información de sesión -->
<div class="modal fade" id="sesionModal" tabindex="-1" aria-labelledby="sesionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sesionModalLabel">Información de Sesión</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if user_info %}
                    <div class="alert alert-success">
                        <h6 class="alert-heading">¡Bienvenido!</h6>
                        <p class="mb-1"><strong>Nombre:</strong> {{ user_info.nombre }}</p>
                        <p class="mb-1"><strong>Email:</strong> {{ user_info.email }}</p>
                        <p class="mb-0"><strong>Tipo de usuario:</strong> 
                            <span class="badge bg-primary">{{ user_info.tipo }}</span>
                        </p>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="{% url 'cerrar_sesion' %}" class="btn btn-danger">
                            <svg width="16" height="16" class="me-2"><use xlink:href="#user"></use></svg>
                            Cerrar Sesión
                        </a>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">No has iniciado sesión</h6>
                        <p class="mb-0">Para acceder a todas las funcionalidades, por favor inicia sesión.</p>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="{% url 'iniciar_sesion' %}" class="btn btn-primary">
                            <svg width="16" height="16" class="me-2"><use xlink:href="#user"></use></svg>
                            Iniciar Sesión
                        </a>
                    </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Formulario de Registro de Empresa -->
  <div class="formbold-form-wrapper form-step active" id="step2">
    
   <!-- <img src="your-image-url-here.jpg">-->

  <form id="empresaForm" action="" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

      <div class="formbold-form-title">
        <h2 class="" style="text-align: center;">Registrarse Empresa</h2>
        <p style="text-align: center; color: #666; margin-top: 10px;">Completa la información de tu empresa</p>
      </div>

      <div class="formbold-input-flex">
        <div>
          <label for="nombre_empresa" class="formbold-form-label">
            Nombre Empresa
          </label>
          <input
            type="text"
            name="nombre_empresa"
            id="firstname"
            class="formbold-form-input" required
          />
        </div>
        <div>
          <label for="correo_empresa" class="formbold-form-label"> Email Empresa </label>
          <input
            type="email"
            name="correo_empresa"
            id="correo_empresa"
            class="formbold-form-input"
            required
          />
        </div>
      </div>

      <div class="formbold-input-flex">
        <div>
          <label for="password_empresa" class="formbold-form-label"> Contraseña Empresa </label>
          <input
            type="password"
            name="password_empresa"
            id="password_empresa"
            class="formbold-form-input"
            required
          />
        </div>
        <div>
          <label for="confirm_password" class="formbold-form-label"> Confirmar Contraseña </label>
          <input
            type="password"
            name="confirm_password"
            id="confirm_password"
            class="formbold-form-input"
            required
          />
        </div>
      </div>

      <div class="formbold-input-flex">
        <div>
          <label for="phone" class="formbold-form-label"> Número Teléfono </label>
          <input
            type="text"
            name="phone"
            id="phone"
            class="formbold-form-input"
          />
        </div>
        <div>
          <label for="direccion_empresa" class="formbold-form-label">
            Dirección Empresa
          </label>
          <input
            type="text"
            name="direccion_empresa"
            id="direccion_empresa"
            class="formbold-form-input"
            placeholder="Dirección de la empresa..."
          />
        </div>
      </div>

      <div class="formbold-input-flex">
        <div>
          <label for="pais_empresa" class="formbold-form-label"> País </label>
          <input type="text" name="pais_empresa" id="country" class="formbold-form-input" value="Venezuela" readonly />
        </div>
        <div>
          <label for="estado_empresa" class="formbold-form-label"> Estado </label>
          <select
            name="estado_empresa"
            id="state"
            class="formbold-form-input select2"
            data-placeholder="Selecciona un estado"
            style="height: 45px;"
          >
            <option value=""></option>
            <option value="Amazonas">Amazonas</option>
            <option value="Anzoátegui">Anzoátegui</option>
            <option value="Apure">Apure</option>
            <option value="Aragua">Aragua</option>
            <option value="Barinas">Barinas</option>
            <option value="Bolívar">Bolívar</option>
            <option value="Carabobo">Carabobo</option>
            <option value="Caracas">Caracas</option>
            <option value="Cojedes">Cojedes</option>
            <option value="Delta Amacuro">Delta Amacuro</option>
            <option value="Distrito Capital">Distrito Capital</option>
            <option value="Falcón">Falcón</option>
            <option value="Guárico">Guárico</option>
            <option value="Lara">Lara</option>
            <option value="Mérida">Mérida</option>
            <option value="Miranda">Miranda</option>
            <option value="Monagas">Monagas</option>
            <option value="Nueva Esparta">Nueva Esparta</option>
            <option value="Portuguesa">Portuguesa</option>
            <option value="Sucre">Sucre</option>
            <option value="Táchira">Táchira</option>
            <option value="Trujillo">Trujillo</option>
            <option value="Vargas">Vargas</option>
            <option value="Yaracuy">Yaracuy</option>
            <option value="Zulia">Zulia</option>
          </select>
        </div>
      </div>

      <div class="formbold-mb-3">
        <label for="descripcion_empresa" class="formbold-form-label"> Descripción Empresa </label>
        <textarea
          name="descripcion_empresa"
          id="descripcion_empresa"
          class="formbold-form-input descripcion-textarea"
          rows="4"
          placeholder="Describe a tu empresa y sus valores..."
        ></textarea>
      </div>

      <div class="formbold-mb-3">
        <label for="tipo_empresa" class="formbold-form-label"> Tipo de Empresa </label>
        <select
          name="tipo_empresa"
          id="tipo_empresa"
          class="formbold-form-input select2"
          data-placeholder="Selecciona el tipo de empresa"
        >
          <option value=""></option>
          <option value="pequena">Pequeña Empresa</option>
          <option value="mediana">Mediana Empresa</option>
          <option value="grande">Grande Empresa</option>
        </select>
      </div>

      <div class="formbold-mb-3">
        <label class="formbold-form-label">Ubicación de la Empresa</label>
        <div class="map-container">
          <div class="search-container" style="margin-bottom: 10px;">
            <div style="margin-left: 10px;">
            <div id="locationStatus" style="color: #2196F3; font-size: 14px; font-weight: 500;">
              <span id="locationIcon">⏳</span> Inicializando mapa...
            </div>
            <button type="button" onclick="retryLocation()" style="margin-top: 5px; background-color: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; display: none;" id="retryButton">
              🔄 Reintentar ubicación
            </button>
          </div>
          </div>
          <div id="map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
          <div class="formbold-input-flex" style="margin-top: 15px;">
            <div>
              <label for="latitud" class="formbold-form-label">Latitud</label>
              <input
                type="text"
                name="latitud"
                id="latitud"
                class="formbold-form-input"
                readonly
              />
            </div>
            <div>
              <label for="longitud" class="formbold-form-label">Longitud</label>
              <input
                type="text"
                name="longitud"
                id="longitud"
                class="formbold-form-input"
                readonly
              />
            </div>
          </div>
        </div>
      </div>

      <div class="formbold-mb-3">
        <label for="logo_empresa" class="formbold-form-label">
          Logo Empresa
        </label>
        <div class="file-upload-wrapper">
          <div class="file-upload-container">
            <input
              type="file"
              name="logo_empresa"
              id="logo_empresa"
              class="formbold-form-input file-input"
              accept="image/*"
              onchange="previewImage(this)"
            />
            <div class="file-upload-placeholder">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="#536387" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M17 8L12 3L7 8" stroke="#536387" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 3V15" stroke="#536387" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Seleccionar imagen</span>
            </div>
            <div class="image-preview" id="imagePreview"></div>
          </div>
        </div>
      </div>

      <div class="formbold-checkbox-wrapper">
        <label for="supportCheckbox" class="formbold-checkbox-label">
          <div class="formbold-relative">
            <input
              type="checkbox"
              id="supportCheckbox"
              class="formbold-input-checkbox"
            />
            <div class="formbold-checkbox-inner">
              <span class="formbold-opacity-0">
                <svg
                  width="11"
                  height="8"
                  viewBox="0 0 11 8"
                  fill="none"
                  class="formbold-stroke-current"
                >
                  <path
                    d="M10.0915 0.951972L10.0867 0.946075L10.0813 0.940568C9.90076 0.753564 9.61034 0.753146 9.42927 0.939309L4.16201 6.22962L1.58507 3.63469C1.40401 3.44841 1.11351 3.44879 0.932892 3.63584C0.755703 3.81933 0.755703 4.10875 0.932892 4.29224L0.932878 4.29225L0.934851 4.29424L3.58046 6.95832C3.73676 7.11955 3.94983 7.2 4.1473 7.2C4.36196 7.2 4.55963 7.11773 4.71406 6.9584L10.0468 1.60234C10.2436 1.4199 10.2421 1.1339 10.0915 0.951972ZM4.2327 6.30081L4.2317 6.2998C4.23206 6.30015 4.23237 6.30049 4.23269 6.30082L4.2327 6.30081Z"
                    stroke-width="0.4"
                  ></path>
                </svg>
              </span>
            </div>
          </div>
          I agree to the defined
          <a href="#"> terms, conditions, and policies</a>
        </label>
      </div>

      <div class="container-login100-form-btn">
        <button class="login100-form-btn" type="submit">
          Registrarse
        </button>
      </div>
    </form>
  </div>
</div>




<!-- Scripts -->
<script src="{% static 'registrar_empresa/js/main.js' %}"></script>
<script>
    // Unificar ambos manejadores DOMContentLoaded para login y registro empresa
    document.addEventListener('DOMContentLoaded', function() {
      // --- Registro de empresa ---
      var empresaForm = document.getElementById('empresaForm');
      if (empresaForm) {
        empresaForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(empresaForm);
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
          if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken);
          }
          Swal.fire({
            title: 'Registrando empresa...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
          });
          fetch('', {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success && data.redirect_url) {
              Swal.fire({
                icon: 'success',
                title: '¡Empresa registrada!',
                text: data.message || 'Redirigiendo...',
                timer: 1800,
                showConfirmButton: false
              }).then(() => {
                window.location.href = data.redirect_url;
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message || 'No se pudo registrar la empresa.'
              });
            }
          })
          .catch(error => {
            Swal.fire({
              icon: 'error',
              title: 'Error de conexión',
              text: 'No se pudo conectar con el servidor.'
            });
          });
        });
      }
      // Validación de confirmación de contraseña
      const passwordField = document.getElementById('password_empresa');
      const confirmPasswordField = document.getElementById('confirm_password');
      
      if (passwordField && confirmPasswordField) {
        confirmPasswordField.addEventListener('blur', function() {
          if (passwordField.value !== confirmPasswordField.value) {
            confirmPasswordField.setCustomValidity('Las contraseñas no coinciden');
          } else {
            confirmPasswordField.setCustomValidity('');
          }
        });
        
        passwordField.addEventListener('input', function() {
          if (confirmPasswordField.value && passwordField.value !== confirmPasswordField.value) {
            confirmPasswordField.setCustomValidity('Las contraseñas no coinciden');
          } else {
            confirmPasswordField.setCustomValidity('');
          }
        });
      }
    });
    
    // Inicializar el mapa al cargar la página
    initializeApp();
    
    // Función para cargar Google Maps de forma más robusta - COMENTADA PARA EVITAR CONFLICTO
    /*
    function loadGoogleMaps() {
        console.log('Cargando Google Maps...');
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyArSSR_2q1ZpCJCOKWNLtuCLc5Z2imrzZY&libraries=places&callback=initMap';
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.error('Error al cargar Google Maps');
            initMapFallback();
        };
        script.onload = function() {
            console.log('Google Maps cargado exitosamente');
        };
        document.head.appendChild(script);
    }
    */
    
    // Verificar que todos los scripts necesarios estén cargados
    function checkDependencies() {
        if (typeof $ === 'undefined') {
            console.error('jQuery no está cargado');
            return false;
        }
        if (typeof Swal === 'undefined') {
            console.error('SweetAlert2 no está cargado');
            return false;
        }
        return true;
    }
    
    // Cargar Google Maps cuando el DOM esté listo y las dependencias estén disponibles
    function initializeApp() {
        if (checkDependencies()) {
            // loadGoogleMaps(); // COMENTADO PARA EVITAR CONFLICTO
            console.log('Dependencias verificadas correctamente');
        } else {
            console.error('Dependencias no disponibles');
            setTimeout(initializeApp, 1000);
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
    } else {
        initializeApp();
    }
</script>

</body>
</html>
{% endblock %}