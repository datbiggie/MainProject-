{% load static %}
{% include 'ecommerce_app/barra_superior_operaciones.html' %}
<!doctype html>
<html lang="es">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700,900&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'servicio/css/bootstrap.min.css' %}">
    
    <!-- Style -->
    <link rel="stylesheet" href="{% static 'servicio/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'servicio/css/main.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <title>Servicios</title>
  </head>
  <body>
  
  <div class="content">
    <div class="container">
      <div class="row align-items-stretch no-gutters contact-wrap">
        <div class="col-md-8">
          <div class="form h-100">
            <h3 class="text-center mb-4" style="color: #35477d; font-weight: 700; letter-spacing: 1px;">SERVICIOS</h3>
            <form class="mb-5" method="post" id="servicioForm" name="servicioForm" action="{% url 'servicio_funcion' %}" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="row">
                <div class="col-md-12 form-group mb-5">
                  <label for="nombre" class="col-form-label">Nombre del Servicio *</label>
                  <input type="text" class="form-control" name="nombre_servicio_{% if user_info.tipo == 'empresa' %}empresa{% else %}usuario{% endif %}" id="nombre_servicio" placeholder="Ingrese el nombre del servicio" style="max-width: 300px;">
                </div>
              </div>

              <div class="row">
                <div class="col-md-12 form-group mb-5">
                  <label for="descripcion" class="col-form-label">Descripción del Servicio</label>
                  <textarea class="form-control" name="descripcion_servicio_{% if user_info.tipo == 'empresa' %}empresa{% else %}usuario{% endif %}" id="descripcion_servicio" cols="30" rows="3" placeholder="Ingrese la descripción del servicio" style="border: 2px solid #ced4da; border-radius: 0.25rem;"></textarea>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 form-group mb-5">
                  <label for="categoria" class="col-form-label">Categoría del Servicio *</label>
                  <select class="form-control" name="categoria_servicio" id="categoria_servicio">
                    <option value="">Seleccione una categoría</option>
                    {% for categoria in categoria_servicio_all %}
                      {% if user_info.tipo == 'empresa' %}
                        <option value="{{ categoria.id_categoria_serv_empresa }}">{{ categoria.nombre_categoria_serv_empresa }}</option>
                      {% else %}
                        <option value="{{ categoria.id_categoria_serv_usuario }}">{{ categoria.nombre_categoria_serv_usuario }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
                
                <!-- Campos adicionales solo para usuarios con rol 'persona' -->
                {% if user_info.tipo == 'persona' %}
                <div class="col-md-6 form-group mb-5">
                  <label for="precio_servicio" class="col-form-label">Precio del Servicio *</label>
                  <input type="number" class="form-control" name="precio_servicio_usuario" id="precio_servicio" step="0.01" min="0" placeholder="0.00" style="max-width: 200px;">
                </div>
                {% endif %}
              </div>
              
              {% if user_info.tipo == 'persona' %}
              <div class="row">
                <div class="col-md-6 form-group mb-5">
                  <label for="estatus_servicio" class="col-form-label">Estatus del Servicio *</label>
                  <select class="form-control" name="estatus_servicio_usuario" id="estatus_servicio" style="max-width: 200px;">
                    <option value="Activo">Activo</option>
                    <option value="Inactivo">Inactivo</option>
                  </select>
                </div>
              </div>
              {% endif %}

              <div class="row">
                <div class="col-md-12 form-group mb-5">
                  <label class="col-form-label">Imágenes del Servicio (máximo 5) <span style="color:red">*</span></label>
                  <p class="text-muted small mb-3">Selecciona al menos una imagen para tu servicio</p>
                  
                  <!-- 5 inputs individuales para imágenes -->
                  <div class="image-inputs-container">
                    <div class="row">
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="imagen_servicio_1" class="form-label">Imagen 1</label>
                        <input type="file" name="imagen_servicio_1" id="imagen_servicio_1" class="form-control" accept="image/*">
                        <div id="preview_servicio_1" class="image-preview mt-2"></div>
                      </div>
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="imagen_servicio_2" class="form-label">Imagen 2</label>
                        <input type="file" name="imagen_servicio_2" id="imagen_servicio_2" class="form-control" accept="image/*">
                        <div id="preview_servicio_2" class="image-preview mt-2"></div>
                      </div>
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="imagen_servicio_3" class="form-label">Imagen 3</label>
                        <input type="file" name="imagen_servicio_3" id="imagen_servicio_3" class="form-control" accept="image/*">
                        <div id="preview_servicio_3" class="image-preview mt-2"></div>
                      </div>
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="imagen_servicio_4" class="form-label">Imagen 4</label>
                        <input type="file" name="imagen_servicio_4" id="imagen_servicio_4" class="form-control" accept="image/*">
                        <div id="preview_servicio_4" class="image-preview mt-2"></div>
                      </div>
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="imagen_servicio_5" class="form-label">Imagen 5</label>
                        <input type="file" name="imagen_servicio_5" id="imagen_servicio_5" class="form-control" accept="image/*">
                        <div id="preview_servicio_5" class="image-preview mt-2"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-12 form-group">
                  <input type="submit" value="Guardar Servicio" class="btn btn-primary rounded-0 py-2 px-4">
                  <a href="{% url 'servicio_config_funcion' %}" class="btn btn-ver-categorias rounded-0 py-2 px-4 ms-2" style="font-weight:500;">
                    Ver Servicios
                  </a>
                  <span class="submitting"></span>
                </div>
              </div>
              <!-- Validación de imagen obligatoria -->
            </form>

            <div id="form-message-warning mt-4"></div> 
            <div id="form-message-success">
              ¡Servicio guardado exitosamente!
            </div>

          </div>
        </div>
        <div class="col-md-4">
          <div class="contact-info h-100" style="position: relative; overflow: hidden; padding: 0; background: #f8f9fa;">
            <img src="{% static 'servicio/images/servicios.jpg' %}" alt="Servicios" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; filter: brightness(1.05) contrast(1.05);">
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'servicio/js/jquery-3.3.1.min.js' %}"></script>
  <script src="{% static 'servicio/js/popper.min.js' %}"></script>
  <script src="{% static 'servicio/js/bootstrap.min.js' %}"></script>
  <script src="{% static 'servicio/js/jquery.validate.min.js' %}"></script>
  <script src="{% static 'servicio/js/main.js' %}"></script>
  <script src="{% static 'servicio/js/validacion_servicio.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Función para crear previsualización de imagen
      function createImagePreview(file, previewContainer) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewContainer.innerHTML = '';
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.width = '100%';
          img.style.maxWidth = '150px';
          img.style.height = '100px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          img.style.border = '2px solid #ddd';
          img.style.marginTop = '10px';
          previewContainer.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
      
      // Configurar event listeners para cada input de imagen
      for (let i = 1; i <= 5; i++) {
        const input = document.getElementById(`imagen_servicio_${i}`);
        const preview = document.getElementById(`preview_servicio_${i}`);
        
        if (input && preview) {
          input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              createImagePreview(file, preview);
            } else {
              preview.innerHTML = '';
            }
          });
        }
      }
      
      // Función para verificar si al menos una imagen está seleccionada
      function hasAtLeastOneImage() {
        for (let i = 1; i <= 5; i++) {
          const input = document.getElementById(`imagen_servicio_${i}`);
          if (input && input.files.length > 0) {
            return true;
          }
        }
        return false;
      }
    
    // Validación personalizada para imágenes
    $.validator.addMethod("atLeastOneImage", function(value, element) {
      return hasAtLeastOneImage();
    }, "Debes seleccionar al menos una imagen.");
    
    // Configuración de validación
    $("#servicioForm").validate({
      rules: {
        nombre_servicio: {
          required: true,
          minlength: 2
        },
        descripcion_servicio: {
          required: true,
          minlength: 10
        },
        categoria_servicio: {
          required: true
        },
        imagen_servicio_1: {
          atLeastOneImage: true
        }
      },
      messages: {
        nombre_servicio: {
          required: "Por favor ingresa el nombre del servicio",
          minlength: "El nombre debe tener al menos 2 caracteres"
        },
        descripcion_servicio: {
          required: "Por favor ingresa la descripción del servicio",
          minlength: "La descripción debe tener al menos 10 caracteres"
        },
        categoria_servicio: {
          required: "Por favor selecciona una categoría"
        },
        imagen_servicio_1: {
          atLeastOneImage: "Por favor selecciona al menos una imagen"
        }
      },
      errorElement: 'div',
      errorClass: 'invalid-feedback',
      validClass: 'is-valid',
      errorPlacement: function(error, element) {
        error.addClass('invalid-feedback');
        element.closest('.form-group').append(error);
      },
      highlight: function(element, errorClass, validClass) {
        $(element).addClass('is-invalid').removeClass('is-valid');
      },
      unhighlight: function(element, errorClass, validClass) {
        $(element).removeClass('is-invalid').addClass('is-valid');
      }
    });
    
    // Manejo del envío del formulario
    var form = document.getElementById('servicioForm');
    if (!form) return;
    form.addEventListener('submit', function(e) {
      var nombre = document.getElementById('nombre_servicio').value.trim();
      var descripcion = document.getElementById('descripcion_servicio').value.trim();
      var categoria = document.getElementById('categoria_servicio').value;
      var imagenInput = document.getElementById('imagenes_servicio');
      let mensaje = '';
      if (!nombre) mensaje = 'El nombre del servicio es obligatorio.';
      else if (!categoria) mensaje = 'Debes seleccionar una categoría.';
      else if (!imagenInput.files || imagenInput.files.length === 0) mensaje = 'Debes seleccionar al menos una imagen para el servicio.';
      else if (imagenInput.files.length > 5) mensaje = 'Máximo 5 imágenes permitidas.';
      if (mensaje) {
        e.preventDefault();
        Swal.fire({
          title: 'Validación',
          text: mensaje,
          icon: 'warning',
          confirmButtonColor: '#d33',
        });
        return false;
      }
    });
  });
  </script>

  </body>
</html>