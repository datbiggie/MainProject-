{% load static %}
{% include 'ecommerce_app/barra_superior_index.html' %}

<!DOCTYPE html>
<html lang="es">
<head>
    <title>Finalizar Pedido</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="{% static 'index/style.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <link rel="stylesheet" href="{% static 'pedido/css/pedido.css' %}">
</head>

<body>
    <div class="checkout-container">
        <!-- Header -->
        <div class="checkout-header">
            <h1><i class="fas fa-shopping-cart me-3"></i>Finalizar Pedido</h1>
            {% if user_info %}
                <p class="mb-0">Bienvenido, {{ user_info.nombre }}</p>
            {% endif %}
        </div>

        {% if productos_carrito %}
            <!-- Informaci√≥n General del Cliente -->
            <div class="customer-info-section mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-user-circle me-2"></i>Informaci√≥n General</h4>
                    </div>
                    <div class="card-body">
                        <form id="generalInfoForm">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Nombre Completo:</label>
                                        <input type="text" class="form-control" id="nombre_general" name="nombre" value="{{ user_info.nombre }}" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Email:</label>
                                        <input type="email" class="form-control" id="email_general" name="email" value="{{ user_info.email }}" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Tel√©fono:</label>
                                        <input type="tel" class="form-control" id="telefono_general" name="telefono" value="{{ user_info.telefono }}" placeholder="+58 412 123 4567" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Direcci√≥n de Entrega:</label>
                                        <textarea class="form-control" id="direccion_general" name="direccion_envio" rows="2" placeholder="Ingrese la direcci√≥n completa de entrega" required></textarea>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Notas Adicionales:</label>
                                        <textarea class="form-control" id="notas_general" name="notas_pedido" rows="2" placeholder="Instrucciones especiales"></textarea>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Pedidos por Vendedor -->
            <div class="vendors-section">
                {% for vendedor_clave, productos in productos_por_vendedor.items %}
                    {% if productos %}
                        {% with primer_producto=productos.0 %}
                            <div class="vendor-order-card mb-4">
                                <div class="card shadow-sm border-0">
                                    {% if vendedor_clave|slice:":7" == "usuario" %}
                                        <div class="card-header bg-info text-white">
                                    {% else %}
                                        <div class="card-header bg-warning text-white">
                                    {% endif %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-{% if vendedor_clave|slice:":7" == "usuario" %}user{% else %}building{% endif %} me-2"></i>
                                                {{ primer_producto.vendedor_nombre }}
                                                <span class="badge bg-light text-dark ms-2">{% if vendedor_clave|slice:":7" == "usuario" %}Usuario{% else %}Empresa{% endif %}</span>
                                            </h5>
                                            <div class="vendor-total-badge">
                                                <span class="badge bg-light text-dark fs-6">
                                                    Total: $<span class="vendor-total-{{ primer_producto.vendedor_id }}">0.00</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <!-- Productos del Vendedor -->
                                            <div class="col-lg-8">
                                                <h6 class="text-muted mb-3"><i class="fas fa-shopping-bag me-2"></i>Productos</h6>
                                                <div class="products-list">
                        
                        {% for producto in productos %}
                        
                        <div class="product-item-new mb-3">
                            <div class="row align-items-center">
                               
                                <div class="col-md-5">
                                    <h6 class="mb-1 fw-bold">{{ producto.nombre }}</h6>
                                    <small class="text-muted">{{ producto.descripcion|truncatechars:60 }}</small>
                                </div>
                                <div class="col-md-2 text-center">
                                    <span class="badge bg-primary">{{ producto.cantidad }} unidades</span>
                                </div>
                                <div class="col-md-2 text-center">
                                    <strong class="text-success">${{ producto.precio_unitario|floatformat:2 }}</strong>
                                </div>
                                <div class="col-md-2 text-end">
                                    <h6 class="text-primary mb-0 fw-bold">${{ producto.subtotal|floatformat:2 }}</h6>
                                </div>
                            </div>
                        </div>
                        
                        {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Formulario de Pago del Vendedor -->
                            <div class="col-lg-4">
                                <div class="payment-section">
                                    <h6 class="text-muted mb-3"><i class="fas fa-credit-card me-2"></i>M√©todo de Pago</h6>
                                    <form class="vendor-form" data-vendor-id="{{ primer_producto.vendedor_id }}" data-vendor-type="{% if vendedor_clave|slice:":7" == "usuario" %}usuario{% else %}empresa{% endif %}">
                                        <div class="mb-3">
                                            <select class="form-select" name="metodo_pago" required>
                                                <option value="">Seleccionar m√©todo</option>
                                                <option value="efectivo">üíµ Efectivo</option>
                                                <option value="tarjeta">üí≥ Tarjeta de Cr√©dito/D√©bito</option>
                                                <option value="transferencia">üè¶ Transferencia Bancaria</option>
                                                <option value="paypal">üÖøÔ∏è PayPal</option>
                                                <option value="pago_movil">üì± Pago M√≥vil</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Comprobante de Pago -->
                                        <div class="mb-3 comprobante-section" style="display: none;">
                                            <label class="form-label fw-bold">Comprobante de Pago:</label>
                                            <input type="file" class="form-control" name="comprobante_pago" accept="image/*,.pdf">
                                            <div class="form-text text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                JPG, PNG, PDF (m√°x. 5MB)
                                            </div>
                                        </div>
                                        
                                        <!-- Bot√≥n Individual -->
                                        <button type="button" class="btn btn-success btn-finalizar-individual w-100 mb-2" 
                                                data-vendor-id="{{ primer_producto.vendedor_id }}" 
                                                data-vendor-type="{% if vendedor_clave|slice:":7" == "usuario" %}usuario{% else %}empresa{% endif %}" 
                                                data-vendor-name="{{ primer_producto.vendedor_nombre }}">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <span class="btn-text">Finalizar Pedido</span>
                                            <span class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                                        </button>
                                        
                                        <!-- Estado del Pedido -->
                                        <div class="order-status d-none">
                                            <div class="alert alert-success mb-0">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>¬°Pedido Procesado!</strong>
                                                <br><small>ID: <span class="order-id"></span></small>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                        {% endwith %}
                    {% endif %}
                {% endfor %}
            </div>
            
            <!-- Resumen Total y Bot√≥n General -->
            <div class="total-summary-section">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-dark text-white">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumen Total</h4>
                            </div>
                            <div class="col-md-4 text-end">
                                <h4 class="mb-0">Total General: <span class="text-warning">${{ total_productos|floatformat:2 }}</span></h4>
                            </div>
                        </div>
                    </div>
                    <div class="card-body text-center">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <p class="mb-0 text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Puedes finalizar pedidos individuales o todos a la vez
                                </p>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-primary btn-lg btn-finalizar-todos" id="finalizarTodos">
                                    <i class="fas fa-shopping-cart me-2"></i>
                                    <span class="btn-text">Finalizar Todos los Pedidos</span>
                                    <span class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Carrito Vac√≠o -->
            <div class="order-summary">
                <div class="empty-cart">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>Tu carrito est√° vac√≠o</h3>
                    <p>Agrega algunos productos antes de proceder con el pedido.</p>
                    <a href="/ecommerce/" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>Continuar Comprando
                    </a>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Scripts -->
    <script src="{% static 'index/js/jquery-1.11.0.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    <script src="{% static 'index/js/plugins.js' %}"></script>
    <script src="{% static 'index/js/script.js' %}"></script>
    <script src="{% static 'index/js/rating-system.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Datos ocultos para pasar de Django a JavaScript -->
    <div id="django-data" style="display: none;">
        <span id="productos-por-vendedor-data">{% if productos_por_vendedor_json %}{{ productos_por_vendedor_json|safe }}{% else %}{}{% endif %}</span>
        <span id="productos-carrito-data">{% if productos_carrito_json %}{{ productos_carrito_json|safe }}{% else %}[]{% endif %}</span>
        <span id="total-productos-data">{% if total_productos %}{{ total_productos }}{% else %}0{% endif %}</span>
    </div>

    <!-- Pasar datos de Django a JavaScript -->
    <script>
        // Obtener datos desde elementos HTML ocultos
        const productosVendedorElement = document.getElementById('productos-por-vendedor-data');
        const productosCarritoElement = document.getElementById('productos-carrito-data');
        const totalProductosElement = document.getElementById('total-productos-data');
        
        // Parsear los datos JSON
        let productosVendedorData = {};
        let productosCarritoData = [];
        let totalProductosData = 0;
        
        try {
            productosVendedorData = JSON.parse(productosVendedorElement.textContent || '{}');
        } catch (e) {
            console.warn('Error parsing productos_por_vendedor:', e);
        }
        
        try {
            productosCarritoData = JSON.parse(productosCarritoElement.textContent || '[]');
        } catch (e) {
            console.warn('Error parsing productos_carrito:', e);
        }
        
        try {
            totalProductosData = parseFloat(totalProductosElement.textContent || '0');
        } catch (e) {
            console.warn('Error parsing total_productos:', e);
        }
        
        // Datos del carrito desde Django
        window.productosCarritoData = {
            "productos_por_vendedor": productosVendedorData,
            "productos_carrito": productosCarritoData,
            "total_productos": totalProductosData
        };
        
        console.log('Datos cargados desde Django:', window.productosCarritoData);
        console.log('productos_por_vendedor_json raw:', productosVendedorElement.textContent);
        console.log('productos_carrito_json raw:', productosCarritoElement.textContent);
        console.log('total_productos raw:', totalProductosElement.textContent);
        
        // Actualizar totales en la interfaz
        function actualizarTotales() {
            console.log('Actualizando totales...');
            console.log('Datos disponibles:', window.productosCarritoData);
            
            // Calcular totales por vendedor desde productos_por_vendedor
            const productosVendedor = window.productosCarritoData.productos_por_vendedor;
            
            if (productosVendedor && typeof productosVendedor === 'object') {
                Object.keys(productosVendedor).forEach(tipoVendedor => {
                    const productos = productosVendedor[tipoVendedor];
                    console.log(`Procesando ${tipoVendedor}:`, productos);
                    
                    if (Array.isArray(productos)) {
                        // Agrupar por vendedor_id
                        const totalesPorVendedor = {};
                        productos.forEach(producto => {
                            const vendedorId = producto.vendedor_id;
                            if (!totalesPorVendedor[vendedorId]) {
                                totalesPorVendedor[vendedorId] = 0;
                            }
                            const subtotal = parseFloat(producto.subtotal || 0);
                            totalesPorVendedor[vendedorId] += subtotal;
                            console.log(`Vendedor ${vendedorId}: +${subtotal} = ${totalesPorVendedor[vendedorId]}`);
                        });
                        
                        // Actualizar elementos del DOM
                        Object.keys(totalesPorVendedor).forEach(vendedorId => {
                            const totalVendedor = totalesPorVendedor[vendedorId];
                            const vendorTotalElements = document.querySelectorAll(`.vendor-total-${vendedorId}`);
                            console.log(`Actualizando vendor-total-${vendedorId} con ${totalVendedor.toFixed(2)}`);
                            vendorTotalElements.forEach(element => {
                                element.textContent = totalVendedor.toFixed(2);
                            });
                        });
                    }
                });
            } else {
                console.warn('No hay datos de productos_por_vendedor v√°lidos');
            }
        }
        
        // Ejecutar actualizaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', actualizarTotales);
        
        // Tambi√©n ejecutar inmediatamente por si el DOM ya est√° listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', actualizarTotales);
        } else {
            actualizarTotales();
        }
    </script>
 
    <script src="{% static 'pedido/js/pedido.js' %}"></script>
    

</body>
</html>